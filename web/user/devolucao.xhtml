<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/Layout.xhtml">

    <ui:define name="content">

        <script type="text/javascript">
            function handleDialogSubmit(xhr, status, args) {
                if (args.validationFailed) {
                    PF('dlgDevolucao').show();
                } else {
                    PF('dlgDevolucao').hide();
                }
            }
        </script>

        <!--BALAO DE MENSAGEM-->
        <h:form id="topMessage">
            <p:growl showDetail="true" sticky="false" />
        </h:form>

        <h1 class="aw-page-title">Devoluções</h1>

        <!--DIALOG DEVOLVER-->
        <p:dialog header="Devolver locação" widgetVar="dlgDevolucao" modal="true" height="320"  width="800" >

            <p:messages id="messages" showDetail="true" closable="true">
                <p:autoUpdate />
            </p:messages>

            <h:form id="formDevolucao">

                <!--HEADER-->
                <div class="p-grid">
                    <div class="p-col">
                        <div class="box">
                            <h:outputText value="Data de Locacação: #{textFormaterService.formatData(devolucaoMB.locacao.dataLocacao)}"/>
                        </div>
                    </div>
                    <div class="p-col">
                        <div class="box"><h:outputText value="Data de Devolução Prevista: #{textFormaterService.formatData(devolucaoMB.locacao.dataPrevDevolucao)}"/></div>
                    </div>
                    <div class="p-col">
                        <div class="box"><h:outputText value="Locador: #{devolucaoMB.locacao.dependente.nome}
                                                       - #{devolucaoMB.locacao.dependente.cliente.nome}
                                                       - #{textFormaterService.formatCPF(devolucaoMB.locacao.dependente.cliente.cpf)}"/></div>
                    </div>
                </div>

                <!--ITENSLOCACAO-->
                <h3>Itens da Locacação</h3>
                <p:dataTable value="#{devolucaoMB.listItensLocacao}" var="obj">

                    <p:column headerText="ID">
                        <h:outputText value="#{obj.midia.id}" />
                    </p:column>

                    <p:column headerText="Nome">
                        <h:outputText value="#{obj.midia.acervo.nome}" />
                    </p:column>		

                    <p:column headerText="Tipo">
                        <h:outputText value="#{obj.midia.tipo}" />
                    </p:column>		

                    <p:column headerText="Preço">
                        <h:outputText value="#{textFormaterService.formatDinheiro(obj.preco)}" />
                    </p:column>
                    
                    <p:column headerText="Status">
                        <h:outputText value="Devolvido" rendered="#{obj.devolvido}"/>
                        <h:outputText value="Alugado" rendered="#{!obj.devolvido}"/>
                    </p:column>

                    <p:column headerText="Operação">
                        <h:outputText value="#{obj.operacao}" />
                    </p:column>

                    <p:column headerText="Ações">

                        <!--BOTÃO INVIABILIZAR-->
                        <p:commandButton title="Inviabilizar" 
                                         update="@form" 
                                         styleClass="ui-color-red"
                                         rendered="#{!obj.devolvido}"
                                         actionListener="#{devolucaoMB.devolver(obj, true)}"/>

                        <!--BOTÃO DEVOLVER-->
                        <p:commandButton title="Devolver" 
                                         update="@form" 
                                         styleClass="ui-priority-primary"
                                         rendered="#{!obj.devolvido}"
                                         actionListener="#{devolucaoMB.devolver(obj, false)}"/>

                    </p:column>

                </p:dataTable>

                <!--MULTA-->

                <h:panelGrid columns="1">
                    <h3>Multas</h3>
                    <p:inputTextarea 
                        counter="display" maxlength="255" counterTemplate="{0} caracteres restantes."
                        style="width: 100%"
                        autoResize="false"
                        value="#{devolucaoMB.locacao.descricaoMulta}"/>
                    <h:outputText id="display" />
                    <br/>

                    <h:outputLabel for="valorMulta" value="Valor da multa:"/>
                    <p:inputNumber id="valorMulta" symbol="R$ " value="#{devolucaoMB.locacao.valorMulta}">
                        <f:ajax event="keyup" render="sugestaoValor"/>
                    </p:inputNumber>

                </h:panelGrid>

                <h:panelGrid columns="1">

                    <br/>
                    <h:outputText id="sugestaoValor" value="Valor a ser Pago: R$ #{textFormaterService.formatDinheiro(devolucaoMB.locacao.valorMulta
                                                                + devolucaoMB.locacao.precoLocacao)}" style="font-size: 16px"/>
                    <br/>

                    <h:outputLabel for="valorPago" value="Valor pago: "/>
                    <p:inputNumber id="valorPago"  symbol="R$ " 
                                   value="#{devolucaoMB.locacao.valorPago}"
                                   required="true"
                                   requiredMessage="Preencha o campo valor pago."/>

                </h:panelGrid>

                <br/>

                <p:commandButton 
                    value="Concluir"
                    update="@form, tabelaPrincipal, topMessage"
                    oncomplete="handleDialogSubmit(xhr, status, args)"
                    actionListener="#{devolucaoMB.concluirOperacao()}"/>

            </h:form>

        </p:dialog>


        <!--DIALOG DETALHES-->
        <p:dialog header="Detalhes Locação" widgetVar="dlgDetalhesLocacao" modal="true" height="300" width="800" >

            <h:form id="formDialogDetalhes">
                <!--Informações Gerais-->
                <h:panelGrid columns="2">

                    <h:outputLabel for="detalhesID" value="ID:" />
                    <h:outputText id="detalhesID" value="#{devolucaoMB.locacao.id}"/>

                    <h:outputLabel for="detalhesStatus" value="Status:" />
                    <h:outputText id="detalhesStatus" value="#{devolucaoMB.definirStatus(devolucaoMB.locacao)}"/>

                    <h:outputLabel for="detalhesLocador" value="Locador:" />
                    <h:outputText id="detalhesLocador" 
                                  value="#{devolucaoMB.locacao.dependente.nome} - #{devolucaoMB.locacao.dependente.cliente.nome} 
                                  - #{textFormaterService.formatCPF(devolucaoMB.locacao.dependente.cliente.cpf)}"/>

                    <h:outputLabel for="detalhesDataLocacao" value="Data de Locação:" />
                    <h:outputText id="detalhesDataLocacao" value="#{textFormaterService.formatData(devolucaoMB.locacao.dataLocacao)}"/>

                    <h:outputLabel for="detalhesDataPrevDevolucao" value="Data de Devolução Prevista:" />
                    <h:outputText id="detalhesDataPrevDevolucao" value="#{textFormaterService.formatData(devolucaoMB.locacao.dataPrevDevolucao)}"/>

                    <h:outputLabel for="detalhesDataDevolucao" value="Data de Devolução:" />
                    <h:outputText id="detalhesDataDevolucao" value="#{textFormaterService.formatData(devolucaoMB.locacao.dataDevolucao)}"/>

                    <h:outputLabel for="detalhesDataPagamento" value="Data de Pagamento:" />
                    <h:outputText id="detalhesDataPagamento" value="#{textFormaterService.formatData(devolucaoMB.locacao.dataPagamento)}"/>

                </h:panelGrid>

                <br/>

                <!--Itens de Locação-->
                <p:dataTable id="tabelaItensLocacaoDetalhes" value="#{devolucaoMB.listItensLocacao}" var="obj">

                    <p:column headerText="ID">
                        <h:outputText value="#{obj.midia.id}" />
                    </p:column>

                    <p:column headerText="Nome">
                        <h:outputText value="#{obj.midia.acervo.nome}" />
                    </p:column>		

                    <p:column headerText="Tipo">
                        <h:outputText value="#{obj.midia.tipo}" />
                    </p:column>		

                    <p:column headerText="Data de Lançamento">
                        <h:outputText value="#{textFormaterService.formatData(obj.midia.acervo.dataLancamento)}" />
                    </p:column>

                    <p:column headerText="Gênero">
                        <h:outputText value="#{obj.midia.acervo.genero}" />
                    </p:column>

                    <p:column headerText="Classificação Etária">
                        <h:outputText value="#{obj.midia.acervo.classificacaoEtaria}" />
                    </p:column>

                    <p:column headerText="Preço">
                        <h:outputText value="#{textFormaterService.formatDinheiro(obj.preco)}" />
                    </p:column>
                    
                    <p:column headerText="Status">
                        <h:outputText value="Devolvido" rendered="#{obj.devolvido}"/>
                        <h:outputText value="Alugado" rendered="#{!obj.devolvido}"/>
                    </p:column>

                </p:dataTable>

                <br/>

                <!--Informações de Preço-->

                <h:panelGrid columns="2">

                    <h:outputLabel for="detalhesPrecoLocacao" value="Preço da Locação:" />
                    <h:outputText id="detalhesPrecoLocacao" value="#{textFormaterService.formatDinheiro(devolucaoMB.locacao.precoLocacao)}"/>

                    <h:outputLabel for="detalhesValorPago" value="Valor Pago:" />
                    <h:outputText id="detalhesValorPago" value="#{textFormaterService.formatDinheiro(devolucaoMB.locacao.valorPago)}"/>

                </h:panelGrid>
            </h:form>
        </p:dialog>

        <!--TABELA PRINCIPAL-->
        <h:form id="tabelaPrincipal">

            <p:dataTable value="#{devolucaoMB.listLocacao}" var="obj">

                <p:column headerText="ID">
                    <h:outputText value="#{obj.id}"/>
                </p:column>

                <p:column headerText="Data de Locação">
                    <h:outputText value="#{textFormaterService.formatData(obj.dataLocacao)}"/>
                </p:column>

                <p:column headerText="Data de Devolução Prevista">
                    <h:outputText value="#{textFormaterService.formatData(obj.dataPrevDevolucao)}"/>
                </p:column>

                <p:column headerText="Locador">
                    <h:outputText value="#{obj.dependente.nome} - #{obj.dependente.cliente.nome}"/>
                </p:column>

                <p:column headerText="Atendente">
                    <h:outputText value="#{obj.funcionario.nome}"/>
                </p:column>

                <p:column headerText="Preço">
                    <h:outputText value="#{textFormaterService.formatDinheiro(obj.precoLocacao)}"/>
                </p:column>

                <p:column headerText="Ações">

                    <!--BOTÃO DETALHES-->
                    <p:commandButton title="Detalhes" 
                                     icon="fa fa-envelope-o" 
                                     update="@form, formDialogDetalhes" 
                                     styleClass="ui-color-orange"
                                     actionListener="#{devolucaoMB.carregarItensLocacaoByLocacao(obj)}"
                                     onclick="PF('dlgDetalhesLocacao').show();">
                        <f:setPropertyActionListener value="#{obj}" target="#{devolucaoMB.locacao}"/>
                    </p:commandButton>

                    <!--BOTÃO DEVOLVER-->
                    <p:commandButton title="Devolver" 
                                     icon="fa fa-pencil" 
                                     update="@form, formDevolucao" 
                                     styleClass="ui-priority-primary"
                                     actionListener="#{devolucaoMB.carregarItensLocacaoByLocacao(obj)}"
                                     onclick="PF('dlgDevolucao').show();">
                        <f:setPropertyActionListener value="#{obj}" target="#{devolucaoMB.locacao}"/>
                    </p:commandButton>

                </p:column>

            </p:dataTable>

        </h:form>

    </ui:define>

</ui:composition>